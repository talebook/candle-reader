name: Trigger Candle Reader Event

on:
  workflow_run:
    workflows: ["Build and release dist.zip"]
    types: [completed]
  workflow_dispatch:

jobs:
  trigger-candle-reader:
    runs-on: ubuntu-latest
    
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    
    env:
      TARGET_OWNER: hehetoshang
      TARGET_REPO: talebook
    
    steps:
      - name: Trigger repository_dispatch event
        env:
          # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œ (PAT) è§¦å‘äº‹ä»¶
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TRIGGER_SOURCE="è‡ªåŠ¨è§¦å‘ (æ¥è‡ªå·¥ä½œæµ: ${{ github.event.workflow_run.name }})"
            # ç›´æ¥åœ¨ gh api å‘½ä»¤ä¸­æ„å»º JSONï¼Œä¸ä½¿ç”¨å˜é‡
            gh api \
              -X POST \
              /repos/${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}/dispatches \
              -f event_type='update-candle-reader' \
              -f 'client_payload[triggered_by]=${{ github.repository }}' \
              -f 'client_payload[workflow_run_id]=${{ github.event.workflow_run.id }}' \
              -f 'client_payload[timestamp]=${{ github.event.workflow_run.updated_at }}'
          else
            TRIGGER_SOURCE="æ‰‹åŠ¨è§¦å‘"
            # ç›´æ¥åœ¨ gh api å‘½ä»¤ä¸­æ„å»º JSONï¼Œä¸ä½¿ç”¨å˜é‡
            gh api \
              -X POST \
              /repos/${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}/dispatches \
              -f event_type='update-candle-reader' \
              -f 'client_payload[triggered_by]=${{ github.repository }}' \
              -f 'client_payload[trigger_type]=manual' \
              -f 'client_payload[timestamp]=${{ github.event.created_at }}'
          fi
          
          echo "ğŸš€ å¼€å§‹è§¦å‘ update-candle-reader äº‹ä»¶"
          echo "ğŸ“¦ ç›®æ ‡ä»“åº“: ${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}"
          echo "ğŸ”§ è§¦å‘æ–¹å¼: $TRIGGER_SOURCE"
          echo "âœ… å·²æˆåŠŸè§¦å‘ ${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }} çš„ update-candle-reader äº‹ä»¶"