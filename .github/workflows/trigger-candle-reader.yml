name: Trigger Candle Reader Event

on:
  # è§¦å‘æ¡ä»¶1ï¼šå½“ 'Build and release dist.zip' å·¥ä½œæµæˆåŠŸå®Œæˆæ—¶
  workflow_run:
    workflows: ["Build and release dist.zip"]
    types: [completed]
  # è§¦å‘æ¡ä»¶2ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  trigger-candle-reader:
    runs-on: ubuntu-latest
    
    # ä¿®æ”¹ifæ¡ä»¶ï¼šè‡ªåŠ¨è§¦å‘æ—¶éœ€è¦æ£€æŸ¥æ˜¯å¦æˆåŠŸï¼Œæ‰‹åŠ¨è§¦å‘æ—¶æ— éœ€æ£€æŸ¥
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    
    # ç¯å¢ƒå˜é‡ - ç›´æ¥ç¡¬ç¼–ç ç›®æ ‡ä»“åº“ä¿¡æ¯
    env:
      TARGET_OWNER: hehetoshang
      TARGET_REPO: talebook
    
    steps:
      - name: Trigger repository_dispatch event
        run: |
          # å‡†å¤‡è§¦å‘ä¿¡æ¯
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TRIGGER_SOURCE="è‡ªåŠ¨è§¦å‘ (æ¥è‡ªå·¥ä½œæµ: ${{ github.event.workflow_run.name }})"
            PAYLOAD='{"triggered_by":"${{ github.repository }}", "workflow_run_id":"${{ github.event.workflow_run.id }}", "timestamp":"${{ github.event.workflow_run.updated_at }}"}'
          else
            TRIGGER_SOURCE="æ‰‹åŠ¨è§¦å‘"
            PAYLOAD='{"triggered_by":"${{ github.repository }}", "trigger_type":"manual", "timestamp":"${{ github.event.created_at }}"}'
          fi
          
          echo "ğŸš€ å¼€å§‹è§¦å‘ update-candle-reader äº‹ä»¶"
          echo "ğŸ“¦ ç›®æ ‡ä»“åº“: ${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}"
          echo "ğŸ”§ è§¦å‘æ–¹å¼: $TRIGGER_SOURCE"
          
          # ä½¿ç”¨ GitHub CLI è§¦å‘ update-candle-reader äº‹ä»¶
          gh api \
            -X POST \
            /repos/${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}/dispatches \
            -f event_type='update-candle-reader' \
            -f client_payload="$PAYLOAD"
          
          echo "âœ… å·²æˆåŠŸè§¦å‘ ${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }} çš„ update-candle-reader äº‹ä»¶"
        
        # ä½¿ç”¨ GitHub Actions è‡ªå¸¦çš„ token
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}